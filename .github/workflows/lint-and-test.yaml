name: Lint and test PR

on: pull_request

jobs:
  need-test:
    runs-on: ubuntu-latest
    outputs:
      charts: ${{ steps.list-changed.outputs.changed }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: helm/chart-testing-action@v2.3.1
      - id: list-changed
        run: |
          changed=$(ct --config .github/ct.yaml list-changed)
          if [[ -n "$changed" ]]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

  lint-chart:
    runs-on: ubuntu-latest
    needs: need-test
    if: ${{ needs.need-test.outputs.charts == 'true' }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: helm/chart-testing-action@v2.3.1
      - run: |
          helm plugin install https://github.com/quintush/helm-unittest
      - uses: manusa/actions-setup-minikube@v2.7.2
        with:
          minikube version: v1.20.0
          kubernetes version: v1.25.0
          github token: ${{ secrets.GITHUB_TOKEN }}

      - run: ct --config .github/ct.yaml lint --debug

  docker-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: docker build . -t pdns-stateless:ci
