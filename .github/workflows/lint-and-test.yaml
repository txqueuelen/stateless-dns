name: Lint and test PR

on: pull_request

# Prevent to consume free CI minutes by not running two workflows in the CI at the same time.
concurrency: 
  group: pr-testing
  cancel-in-progress: true

jobs:
  paths-filter:
    name: Filter which jobs need to be run
    runs-on: ubuntu-latest
    outputs:
      workflows: ${{ steps.filter.outputs.workflows }}
      build: ${{ steps.filter.outputs.build }}
      charts: ${{ steps.filter.outputs.charts }}
    steps:
    - uses: actions/checkout@v2
    - uses: dorny/paths-filter@v2
      id: filter
      with:
        filters: |
          workflows:
            - '.github/workflows/**'
          build:
            - 'build/**'
          charts:
            - 'charts/**'


  lint-chart:
    name: Lint charts
    runs-on: ubuntu-latest
    needs: paths-filter
    if: needs.paths-filter.outputs.charts == 'true'
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: Install helm/chart-testing
      uses: helm/chart-testing-action@v2.3.1

    - name: Lint charts
      run: ct --config .github/ct.yaml lint

    - name: Install helm unit test siute
      run: helm plugin install https://github.com/helm-unittest/helm-unittest
    - name: Run unit tests
      run: |
        for chart in $(ct list-changed --config .github/ct-lint.yaml); do
          if [ -d "$chart/tests/" ]; then
            helm unittest $chart -3
          fi
        done

    - name: Install Minikube
      uses: manusa/actions-setup-minikube@v2.7.2
      with:
        minikube version: v1.29.0
        kubernetes version: v1.25.0
        github token: ${{ secrets.GITHUB_TOKEN }}

    - name: Test charts installation
      run: ct --config .github/ct.yaml install


  docker-build:
    name: Build PowerDNS image
    runs-on: ubuntu-latest
    needs: paths-filter
    if: needs.paths-filter.outputs.build == 'true'
    defaults:
      run:
        working-directory: build
    steps:
      - uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Build
        uses: docker/build-push-action@v4
        with:
          tags: ${{ github.repository }}-ci
          cache-from: type=gha
          cache-to: type=gha,mode=max

  e2e:
    name: Run e2e test
    needs: [ lint-chart, docker-build ]
    if: ${{ always() && !( failure() ) }}  # This step has to run always (if any of the needs are skipped) but with no previous job failed.
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: build
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: e2e test
      run: echo placeholder
